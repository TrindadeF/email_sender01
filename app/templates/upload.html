{% extends 'base.html' %}
{% block title %}Upload de Contatos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/upload.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}

{% block content %}

<!-- Adicione logo após o <body> -->
<div class="container mt-3">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="container">
    <h1 class="mb-4">Upload de Lista de Contatos</h1>
    
    <div class="upload-card card">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                <div class="mb-3">
                    <label for="name" class="form-label">Nome da Lista</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>

                <div class="upload-zone" id="uploadZone">
                    <i class="bi bi-cloud-upload upload-icon"></i>
                    <h4>Arraste seu arquivo Excel aqui</h4>
                    <p class="text-muted">ou</p>
                    <div class="file-input-wrapper">
                        <button type="button" class="btn btn-primary">Selecionar Arquivo</button>
                        <input class="form-control" type="file" id="file" name="file" 
                               accept=".xlsx,.xls,.csv">
                    </div>
                    <small class="text-muted d-block mt-2">
                        Formatos suportados: XLSX, XLS, CSV
                    </small>
                </div>

                <div class="file-info" id="fileInfo" style="display: none;">
                    <h5 class="mb-3">Arquivo Selecionado</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1"><strong>Nome:</strong> <span id="fileName">-</span></p>
                            <p class="mb-1"><strong>Tamanho:</strong> <span id="fileSize">-</span></p>
                            <p class="mb-0"><strong>Total de Registros:</strong> <span id="recordCount">-</span></p>
                        </div>
                        <button type="button" class="btn btn-outline-danger" onclick="clearFile()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>

                <div class="preview-section mt-4" id="previewSection" style="display: none;">
                    <h5>Preview dos Dados</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="previewTable">
                            <thead>
                                <tr id="previewHeader"></tr>
                            </thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                    <p class="text-muted small">Mostrando os primeiros 5 registros</p>
                </div>

                <div class="progress mt-4" id="uploadProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary" id="uploadButton">
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if contacts %}
        <div class="mt-5">
            <h4>Contatos Importados</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Titulo</th>
                            <th>Email</th>
                            <th>Nome do Congresso</th>
                            <th>Ano do Congresso</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for contact in contacts %}
                        <tr>
                            <td>{{ contact.titulo }}</td>
                            <td>{{ contact.email }}</td>
                            <td>{{ contact.nome_congresso }}</td>
                            <td>{{ contact.ano_congresso }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Script de upload carregado!'); // Debug
    
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const recordCount = document.getElementById('recordCount');
    const uploadProgress = document.getElementById('uploadProgress');
    const previewSection = document.getElementById('previewSection');
    const previewHeader = document.getElementById('previewHeader');
    const previewBody = document.getElementById('previewBody');
    
    // Ligar o botão ao input de arquivo
    document.querySelector('.file-input-wrapper button').addEventListener('click', function(e) {
        e.preventDefault(); // Evita comportamento padrão
        fileInput.value = ''; // Limpa o valor para garantir o evento change
        fileInput.click();
    });
    // Drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, unhighlight, false);
    });

    uploadZone.addEventListener('drop', handleDrop, false);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        uploadZone.classList.add('drag-over');
    }

    function unhighlight(e) {
        uploadZone.classList.remove('drag-over');
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        handleFileSelection(files[0]);
    }

    // File selection
    fileInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            handleFileSelection(this.files[0]);
        }
    });

    function handleFileSelection(file) {
        // Atualizar informações básicas do arquivo
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        uploadZone.style.display = 'none';

        // Ler o arquivo e mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                if (jsonData.length > 0) {
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    // Atualizar contagem de registros
                    recordCount.textContent = rows.length;

                    // Gerar cabeçalho da tabela
                    previewHeader.innerHTML = headers.map(h => 
                        `<th scope="col">${h}</th>`
                    ).join('');

                    // Gerar linhas de preview (primeiros 5 registros)
                    previewBody.innerHTML = rows.slice(0, 5).map(row => 
                        `<tr>${row.map(cell => 
                            `<td>${cell || ''}</td>`
                        ).join('')}</tr>`
                    ).join('');

                    // Mostrar seção de preview
                    previewSection.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao ler arquivo:', error);
                alert('Erro ao ler o arquivo. Certifique-se de que é um arquivo Excel válido.');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    window.clearFile = function() {
        fileInput.value = '';
        fileInfo.style.display = 'none';
        uploadZone.style.display = 'block';
        uploadProgress.style.display = 'none';
        previewSection.style.display = 'none';
        uploadProgress.querySelector('.progress-bar').style.width = '0%';
    }

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        if (fileInput.files.length > 0) {
            document.getElementById('uploadButton').classList.add('upload-success');
            uploadProgress.style.display = 'block';
            // Simular progresso (em produção, use XHR ou Fetch com progress event)
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                uploadProgress.querySelector('.progress-bar').style.width = progress + '%';
                if (progress >= 100) clearInterval(interval);
            }, 100);
        }
    });
});
</script>
{% endblock %}
